pid /home/charcoal/tmp/nginx.pid;
worker_processes  auto;

events {
  worker_connections  10240;
}

http {
  include  /etc/nginx/mime.types;
  default_type application/octet-stream;

  # Performance
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # Log Format
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

  # Log Files
  access_log /home/charcoal/log/access.log main;
  error_log /home/charcoal/log/error.log warn;
  client_body_temp_path /home/charcoal/tmp/nginx/body 1 2;
  proxy_temp_path /home/charcoal/tmp/nginx/proxy 1 2;
  fastcgi_temp_path /home/charcoal/tmp/nginx/fastcgi 1 2;
  uwsgi_temp_path /home/charcoal/tmp/nginx/uwsgi 1 2;
  scgi_temp_path /home/charcoal/tmp/nginx/scgi 1 2;

  # Security Limitations
  gzip off;
  server_tokens off;
  client_max_body_size 1m;
  client_header_buffer_size 2k;
  large_client_header_buffers 4 8k;
  client_header_timeout 15s;
  client_body_timeout   15s;
  keepalive_timeout     65s;
  send_timeout          30s;

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "same-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header Cross-Origin-Opener-Policy "same-origin" always;
  add_header Cross-Origin-Resource-Policy "same-origin" always;

  # Content-Security-Policy
  # add_header Content-Security-Policy "default-src 'self';" always;

  # TLS Settings
  #ssl_protocols TLSv1.2 TLSv1.3;
  #ssl_prefer_server_ciphers on;
  #ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:
  #             ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:
  #             TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384';

  # FPM Configuration
  upstream charcoal_fpm {
    server 127.0.0.1:9000;
    keepalive 8;
  }

  # Internal health check
  server {
    listen 5999;
    server_name _;

    location = /health {
      default_type text/plain;
      return 200 'OK';
      access_log off;
    }

    location / {
      return 404;
    }
  }

  server {
    listen 6000 default_server;
    listen [::]:6000 default_server;
    server_name _;

    root ${CHARCOAL_SAPI_ROOT};
    index index.php;

    # EDIT: if behind a proxy/load-balancer, trust its IP(s) for real client IP
    # set_real_ip_from  10.0.0.0/8;  # EDIT
    # real_ip_header    X-Forwarded-For;
    # real_ip_recursive on;

    # Base location, serve static files first, reroute to index.php
    location / {
      try_files $uri $uri/ /index.php$is_args$args;
    }

    # Protected Locations
    location ~* \.(?:log|sql|ini|env|bak)$ {
      deny all;
    }

    location ~ /\. {
      deny all;
    }

    # Cache-Control (Static-Assets)
    #location ~* \.(?:css|js|mjs|png|jpg|jpeg|gif|svg|ico|webp|avif|ttf|woff2?)$ {
    #  access_log off;
    #  expires 30d;
    #  add_header Cache-Control "public, max-age=2592000, immutable";
    #  try_files $uri =404;
    #}

    location = /index.php {
      include /etc/nginx/fastcgi_params;
      fastcgi_pass  charcoal_fpm;
      fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
      fastcgi_param DOCUMENT_ROOT $realpath_root;
      fastcgi_read_timeout 60s;
      fastcgi_keep_conn on;
    }

    # Block any other direct .php execution
    location ~ \.php$ { return 404; }
  }
}
